<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Juggler Tests</title>

    <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.4.0.css">
    <script src="https://code.jquery.com/qunit/qunit-2.4.0.js"></script>
    <script src="../Scripts/Juggler.js"></script>
    <script>
        var jugglerPasses = [
            ["AR-3PBL", "AL-3SAR", "AR-3SAL", "AL-3SAR", "AR-3PBL", "AL-3PBR", "AR-3SAL", "AL-3SAR"],
            ["BR-3PAL", "BL-3SBR", "BR-3SBL", "BL-3SBR", "BR-3PAL", "BL-3PAR", "BR-3SBL", "BL-3SBR"]
        ];

        var props = null;



        QUnit.test("Juggler constructor Tests", function(assert) {
            let table = document.getElementById("everyothereveryother");
            let tableRow = table.rows[0].cells;
            let rhythmLength = tableRow.length;

            var juggler = new Juggler("A", tableRow, "fred");
            juggler.setPartnerId("B");

            assert.equal(juggler.id, "A", "The Juggler id is " + juggler.id);
            assert.equal(juggler.name, "fred", "The Jugger name is " + juggler.name);
            assert.equal(juggler.cycleLength, rhythmLength, "Juggler has the correct number of tosses: " + juggler.cycleLength);


            for (var i = 0; i < rhythmLength; ++i) {
                assert.equal(juggler.tosses[i].toFullString(), jugglerPasses[0][i], "Pass " + i + " is " + juggler.tosses[i].toString());
            }
        });

        QUnit.test("Prop List creation", function(assert) {
            props = createPropList(6);
            assert.equal(props.length, 6, "PropList created with the correct length")
            let propNameIndex = 97
            props.forEach(function(prop_, index_) {
                assert.equal(prop_.id, String.fromCharCode(propNameIndex), "Prop " + index_ + " is named " + prop_.id);
                ++propNameIndex;
            }, this);
        });

        QUnit.test("Prop List distribution", function(assert) {
            props = createPropList(6);
            let table = document.getElementById("everyothereveryother");
            let tableRow = table.rows[0].cells;
            let rhythmLength = tableRow.length;

            var jugglers = [new Juggler("A", tableRow, "fred"), new Juggler("B", tableRow, "drew")]

            distributeProps(jugglers, props);

            assert.equal(jugglers[0].hands.get(RightHand).props[0].id, "a", "Juggler A's right hand contains prop 'a'");
            assert.equal(jugglers[1].hands.get(RightHand).props[0].id, "b", "Juggler B's right hand contains prop 'b'");
            assert.equal(jugglers[0].hands.get(LeftHand).props[0].id, "c", "Juggler A's left hand contains prop 'c'");
            assert.equal(jugglers[1].hands.get(LeftHand).props[0].id, "d", "Juggler B's left hand contains prop 'd'");
            assert.equal(jugglers[0].hands.get(RightHand).props[1].id, "e", "Juggler A's right hand contains prop 'e'");
            assert.equal(jugglers[1].hands.get(RightHand).props[1].id, "f", "Juggler B's right hand contains prop 'f'");


        }, this);


        QUnit.test("Juggle 2 cycles", function(assert) {
            function countPropsInFlight(props_) {
                let numberPropsInFlight = 0;
                props.forEach(function(prop_, index_) {
                    if (prop_.isInFlight()) {
                        ++numberPropsInFlight;
                    }
                }, this);
                return numberPropsInFlight;
            }

            numberOfProps = 6;
            props = createPropList(numberOfProps);
            let table = document.getElementById("everyothereveryother");
            let tableRow = table.rows[0].cells;
            let rhythmLength = tableRow.length;

            var jugglers = [new Juggler("A", tableRow, "fred"), new Juggler("B", tableRow, "drew")];
            jugglers[0].setPartnerId(jugglers[1].id);
            jugglers[1].setPartnerId(jugglers[0].id);

            distributeProps(jugglers, props);

            let propTossedIndex = 0;
            for (var i = 0; i < (rhythmLength * 2); ++i) {
                // toss the current toss for each juggler
                jugglers.forEach(function(juggler_, index_, jugglers_) {
                    let prop = juggler_.Toss();
                    assert.equal(prop.toss.toFullString(), jugglerPasses[index_][i % rhythmLength], "Juggler " + juggler_.id + " tossed " + jugglerPasses[index_][i % rhythmLength]);
                    // As there are only 2 juggler this adding 1 and mod it by 2 will flip the index
                    var receivingJuggler = jugglers_.find(function(j_) {
                        return j_.id == prop.toss.juggler;
                    });
                    receivingJuggler.addInComingProp(prop);
                    assert.equal(receivingJuggler.inComingProps[prop.toss.magnitude - 2].id, prop.id, "Prop " + prop.id + " added to incoming list of Juggler " + receivingJuggler.id);
                    ++propTossedIndex;
                }, this);

                let numberPropsInFlight = countPropsInFlight(props);
                if (propTossedIndex > 2) {
                    assert.equal(numberPropsInFlight, 4, "There are 4 clubs in flight");
                } else {
                    assert.equal(numberPropsInFlight, 2, "There are 2 clubs in flight");
                }

                jugglers.forEach(function(juggler_, index_) {
                    let prop = juggler_.Catch();
                    if (i < 1) {
                        assert.equal(prop, null, "Waiting for first catch");
                    }
                }, this);

                numberPropsInFlight = countPropsInFlight(props);
                assert.equal(numberPropsInFlight, 2, "After catch there are only 2 props in flight");

            }

        }, this);
    </script>
</head>

<body>

    <div id="qunit"></div>

    <table id="everyothereveryother">
        <tr>
            <td>P</td>
            <td>S</td>
            <td>S</td>
            <td>S</td>
            <td>P</td>
            <td>P</td>
            <td>S</td>
            <td>S</td>
        </tr>
    </table>

    <table id="jims3count">
        <tr>
            <td>P</td>
            <td>S</td>
            <td>S</td>
        </tr>
        <tr>
            <td>D</td>
            <td>S</td>
            <td>S</td>
        </tr>
    </table>

</body>

</html>